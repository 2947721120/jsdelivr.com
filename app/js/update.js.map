{"version":3,"file":"update.js","sources":["../.gobble-build/13-include/1/js/update.js"],"sourcesContent":["import _ from 'lodash';\nimport request from 'request-promise';\nimport algoliaSearch from 'algoliasearch';\nimport { db as algoliaIndex } from './search';\nimport algoliaConfig from '../config/algolia';\nimport logger from './logger';\n\nlet appLog = logger('app');\nlet client = algoliaSearch(algoliaConfig.appID, algoliaConfig.writeAccessToken);\nlet jsDelivrIndex = client.initIndex('jsDelivr');\nlet jsDelivrAssetsIndex = client.initIndex('jsDelivr_assets');\n\nsetInterval(updateIndex, 60000);\n\nfunction updateIndex () {\n\trequest('https://api.jsdelivr.com/v1/jsdelivr/libraries').then((body) => {\n\t\treturn JSON.parse(body);\n\t}).then((data) => {\n\t\t_.forEach(data, project => {\n\t\t\tlet aProject = algoliaIndex[project.name];\n\n\t\t\tif (!aProject || project.versions.length > aProject.versions.length) {\n\t\t\t\tproject = _.pick(project, [ 'name', 'mainfile', 'lastversion', 'description', 'homepage', 'github', 'author', 'versions', 'assets' ]);\n\t\t\t\tproject.objectID = project.name;\n\t\t\t\tproject.lastupdate = Date.now();\n\n\t\t\t\tappLog.info(`Updating project ${project.name}.`);\n\t\t\t\talgoliaIndex[project.name] = _.merge({}, project);\n\n\t\t\t\t// Save each version as a separate record for big projects.\n\t\t\t\tif (JSON.stringify(project).length > 100000) {\n\t\t\t\t\tlet assets = [];\n\t\t\t\t\tappLog.info(`Project ${project.name} is too big. Each version will be stored as a separate record.`);\n\n\t\t\t\t\t_.forEach(project.assets, (entry) => {\n\t\t\t\t\t\tassets.push({\n\t\t\t\t\t\t\tobjectID: `${project.objectID}-${entry.version}`,\n\t\t\t\t\t\t\tname: project.name,\n\t\t\t\t\t\t\tversion: entry.version,\n\t\t\t\t\t\t\tfiles: entry.files,\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\t// Still too big?\n\t\t\t\t\t\tif (JSON.stringify(assets[assets.length - 1]).length > 100000) {\n\t\t\t\t\t\t\tappLog.notice(`Project ${project.name} v${entry.version} is too big. Only main file will be included.`);\n\t\t\t\t\t\t\tassets[assets.length - 1].files = [ project.mainfile ];\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\tjsDelivrAssetsIndex.saveObjects(assets).catch((error) => {\n\t\t\t\t\t\tappLog.err(`Couldn't update project ${project.name} (jsDelivr_assets): ${error}`);\n\t\t\t\t\t});\n\n\t\t\t\t\tproject.assets = [];\n\t\t\t\t}\n\n\t\t\t\tjsDelivrIndex.saveObject(project).catch((error) => {\n\t\t\t\t\tappLog.err(`Couldn't update project ${project.name} (jsDelivr): ${error}`);\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t});\n}\n"],"names":[],"mappings":"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"}