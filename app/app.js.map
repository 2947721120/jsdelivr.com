{"version":3,"file":"app.js","sources":["../.gobble-build/13-include/1/app.js"],"sourcesContent":["import express from 'express';\r\nimport bodyParser from 'body-parser';\r\nimport compression from 'compression';\r\nimport favicon from 'serve-favicon';\r\nimport morgan from 'morgan';\r\nimport isBot from 'is-bot';\r\nimport Ractive from 'ractive';\r\nimport ractiveLoad from 'ractive-load';\r\nimport rr from 'ractive-render';\r\nimport eh from 'express-handlebars';\r\n\r\nimport morganConfig from './config/morgan';\r\nimport dnsApi from './js/api/dns';\r\nimport mailApi from './js/api/mail';\r\nimport statsApi from './js/api/stats';\r\nimport logger from './js/logger';\r\nimport render from './js/render';\r\nimport sitemap from './js/sitemap';\r\nimport './js/update';\r\n\r\nlet appLog = logger('app');\r\nlet app = express();\r\n\r\n/**\r\n * Express config.\r\n */\r\napp.use(favicon(__dirname + '/public/img/favicon.ico'));\r\napp.use(morgan(morganConfig.format, morganConfig.options));\r\napp.use(compression());\r\napp.use(express.static(__dirname + '/public', { maxAge: 3600000 }));\r\napp.use(bodyParser.json());\r\n\r\napp.set('views', __dirname + '/views');\r\napp.set('view engine', 'html');\r\napp.set('x-powered-by', false);\r\n\r\napp.engine('html', rr.renderFile);\r\napp.engine('xml', eh());\r\n\r\n/**\r\n * ractive-render config.\r\n */\r\nrr.use('load').config({ componentsLoader: 'load', defaultLoader: 'load' });\r\nractiveLoad.baseUrl = __dirname;\r\n\r\n// Tell our components not to use browser specific stuff.\r\nRactive.isServer = true;\r\nRactive.DEBUG = false;\r\n\r\n/**\r\n * Private APIs used by our frontend.\r\n */\r\napp.all('/api/dns', dnsApi);\r\napp.all('/api/mail', mailApi);\r\napp.all('/api/stats', statsApi);\r\n\r\n/**\r\n * sitemap.xml\r\n */\r\napp.all('/sitemap.xml', sitemap);\r\n\r\n/**\r\n * Make caching work correctly, as we'll be sending rendered pages for bots.\r\n */\r\napp.use((req, res, next) => {\r\n\tres.vary('User-Agent');\r\n\tnext();\r\n});\r\n\r\n/**\r\n * Redirect from old urls.\r\n */\r\napp.use((req, res, next) => {\r\n\tif (!req.query._escaped_fragment_) {\r\n\t\treturn next();\r\n\t}\r\n\r\n\tres.redirect(301, `/projects/${req.query._escaped_fragment_.replace(/\\r|\\n/g, '')}`);\r\n});\r\n\r\n/**\r\n * Render on server side if it's a bot.\r\n */\r\napp.use((req, res, next) => {\r\n\tif (!isBot(req.headers['user-agent'])) {\r\n\t\treturn next();\r\n\t}\r\n\r\n\trender(req, res);\r\n});\r\n\r\n/**\r\n * Just send a template and render on client side.\r\n */\r\napp.all('/*', (req, res) => {\r\n\tres.sendFile(__dirname + '/views/app.html');\r\n});\r\n\r\napp.listen(process.env.PORT || 4400, function () {\r\n\tappLog.info(`Express server listening on port ${this.address().port}.`);\r\n});\r\n\r\nprocess.on('uncaughtException', (error) => {\r\n\tconsole.error('CRITICAL ERROR (exiting in 10 seconds):', error, error.stack);\r\n\tappLog.crit(error);\r\n\r\n\tsetTimeout(() => {\r\n\t\tprocess.exit(1);\r\n\t}, 10000);\r\n});\r\n"],"names":[],"mappings":"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"}